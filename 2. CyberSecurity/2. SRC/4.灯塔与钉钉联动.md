# 灯塔与钉钉联动

> 操作系统: **CentOs7**

> 补充: 灯塔是个开源的系统, 具体可以参照GitHub资产灯塔ARL连接[https://github.com/TophantTechnology/ARL/wiki/Docker-%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85-ARL

## Docker 安装

1. 更新Docker源

```
sudo yum update 
sudo yum install -y yum-utils device-mapper-persistent-data lvm2
sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
```

2. 安装docker

```
sudo yum install docker-ce
```

3. 启动docker并查看本机运行状态

```
sudo systemctl start docker   //启动
```

```
sudo systemctl enable docker   //开机自启
```

```
systemctl status docker.service    //查看运转状态
```

​		![image-20230529222658926](https://raw.githubusercontent.com/QDGSCLOUD/BJYH_picture/main/img/image-20230529222658926.png)

## 安装灯塔ARL

> 先出创建一个新的目录, 在执行下方的命令.

````
mkdir docker_arl				//创建arl文件夹
wget -O docker_arl/docker2.5.2.zip https://github.com/TophantTechnology/ARL/releases/download/v2.5.2/docker.zip 							//下载安装包
cd docker_arl					//进入arl文件夹
unzip docker2.5.2.zip			//解压
docker volume create arl_db	//创建docker进程
docker-compose up -d     // 需要超级管理员权限, 否则会报错 .

````

4. 查看进程

   ```
   docker-compose ps
   ```

   ![img](https://raw.githubusercontent.com/QDGSCLOUD/BJYH_picture/main/img/clip_image002.jpg)

2. 重置密码和账号

   ```
   docker exec -ti arl_mongodb mongo -u admin -p admin
   use arl
   db.user.drop()
   db.user.insert({ username: 'admin',  password: hex_md5('arlsalt!@#'+'admin123') })
   exit
   
   ```

   

6. 访问docker

   https://虚拟机IP:5003

   默认账号:admin
   
   ​        密码: admin123

# 与钉钉联动

1. 现在自己在钉钉中建立一个群, 之后设置一个机器人.

   ![image-20230530132121262](https://raw.githubusercontent.com/QDGSCLOUD/BJYH_picture/main/img/image-20230530132121262.png)

2. ![image-20230530132206279](https://raw.githubusercontent.com/QDGSCLOUD/BJYH_picture/main/img/image-20230530132206279.png)![image-20230530132246910](https://raw.githubusercontent.com/QDGSCLOUD/BJYH_picture/main/img/image-20230530132246910.png)



3. 点击`加签`, 复制 "Secket", 找个地方记住就行, 后面要用

   ![image-20230530132359576](https://raw.githubusercontent.com/QDGSCLOUD/BJYH_picture/main/img/image-20230530132359576.png)

4. 后面还会出现一个http连接的 token , 也复制下来, 记住就行

   ![image-20230530132558611](https://raw.githubusercontent.com/QDGSCLOUD/BJYH_picture/main/img/image-20230530132558611.png)

5. 修改并配置文件(一定要在自己解压ARL的文件夹下)

   ```
   vim comfigdocker.yaml
   ```

   ![image-20230530132856886](https://raw.githubusercontent.com/QDGSCLOUD/BJYH_picture/main/img/image-20230530132856886.png)

6. 配置好后, 退出编辑, 输入:

   ```
   docker-compose exec worker bash
   ```

   ```
   python3.6 -m test.test_utils_push
   ```

   **此时大概率会报错, 说python3.6 版本太旧了, 或者`code`文件夹的错误,  没关系. 重启一下就行**,输入如下命令:

   > ```
   > docker-compose restart 
   > ```

   接着再次输入上方的命令:

   ```
   docker-compose exec worker bash
   python3.6 -m test.test_utils_push
   ```

   ![image-20230530133539335](https://raw.githubusercontent.com/QDGSCLOUD/BJYH_picture/main/img/image-20230530133539335.png)

   

ok了, 此时钉钉就会 收到消息啦!



# 灯塔中添加任务

1. 进入自己搭建的灯塔, 添加任务

   ![image-20230530160232420](https://raw.githubusercontent.com/QDGSCLOUD/BJYH_picture/main/img/image-20230530160232420.png)

2. ![image-20230530160505265](https://raw.githubusercontent.com/QDGSCLOUD/BJYH_picture/main/img/image-20230530160505265.png)

   ![image-20230530160602958](https://raw.githubusercontent.com/QDGSCLOUD/BJYH_picture/main/img/image-20230530160602958.png)

> ok啦, 之后到 **任务管理界面就可以看到啦!**, 当然, 运行了才能有记录, 所以得相等一两分钟, 并且, 如果没有扫到新的产品, **钉钉是不会收到消息的.**
>
> ![image-20230530160830125](https://raw.githubusercontent.com/QDGSCLOUD/BJYH_picture/main/img/image-20230530160830125.png)